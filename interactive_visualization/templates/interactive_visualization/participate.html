{% extends "core/base.html" %}
{% block content %}
{% load staticfiles %}

<link rel="stylesheet" href="{% static 'interactive_visualization/css/dc.css' %}">
<script type="text/javascript" src="{% static 'interactive_visualization/js/d3.js' %}"></script>
<script type="text/javascript" src="{% static 'interactive_visualization/js/crossfilter.js' %}"></script>
<script type="text/javascript" src="{% static 'interactive_visualization/js/dc.js' %}"></script>

{% if project.switch_variable %}
<p>
  <strong>{{ project.switch_title }}</strong>
  <div id="dc_switch_{{ project.id }}"></div>
  {{ project.switch_note }}
</p>
{% endif %}

{% if project.bar1_variable %}
<div class="row">
  <div id="bar1_{{ project.id }}_div" style="margin-left: 15px;">
    <strong>{{ project.bar1_title }}</strong>
    <a class="reset" href="javascript:bar1_{{ project.id }}_chart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clearfix"></div>
  </div>
</div>
{% endif %}

{% if project.pie1_variable %}
<div class="row">
  <div id="pie1_{{ project.id }}_div" style="margin-left: 15px;">
    <strong>{{ project.pie1_title }}</strong>
    <a class="reset" href="javascript:pie1_{{ project.id }}_chart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clearfix"></div>
  </div>
</div>
{% endif %}

{% if project.bar2_variable %}
<div class="row">
  <div id="bar2_{{ project.id }}_div" style="margin-left: 15px;">
    <strong>{{ project.bar2_title }}</strong>
    <a class="reset" href="javascript:bar2_{{ project.id }}_chart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clearfix"></div>
  </div>
</div>
{% endif %}

{% if project.pie2_variable %}
<div class="row">
  <div id="pie2_{{ project.id }}_div" style="margin-left: 15px;">
    <strong>{{ project.pie2_title }}</strong>
    <a class="reset" href="javascript:pie2_{{ project.id }}_chart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clearfix"></div>
  </div>
</div>
{% endif %}

<!-- No spaces around commas! This is important!! :( -->
<pre id="data_interactive_visualization_{{ project.id }}" style="display: none;">
{{ project.csv_data }}
</pre>


<script>

{% if project.switch_variable %}
var toggle_column_interactive_visualization_{{ project.id }}="{{ project.switch_variable }}";
{% endif %}

var parsed_data_interactive_visualization_{{ project.id }} = d3.csv.parse(d3.select('pre#data').text());
console.log('parsed data', parsed_data)

var bin_width_interactive_visualization_{{ project.id }}=5
var xfilter_interactive_visualization_{{ project.id }} = crossfilter(parsed_data);



var housing_costs = xfilter_interactive_visualization_{{ project.id }}.dimension(function(d) {return +d.Selected_Housing_Costs;}),
    number_of_samples = housing_costs.group(function(d) { return bin_width_interactive_visualization_{{ project.id }} * Math.floor(1.0 * d / bin_width_interactive_visualization_{{ project.id }})});

var housing_costs_as_a_percentage_of_income = xfilter_interactive_visualization_{{ project.id }}.dimension(function(d) {return 100.0 * +d.Selected_Housing_Costs / +d.Household_Income;}),
    number_of_samples = housing_costs_as_a_percentage_of_income.group(function(d) { return bin_width_interactive_visualization_{{ project.id }} * Math.floor(1.0 * d / bin_width_interactive_visualization_{{ project.id }})});

var chart3 = dc.barChart("#housing_costs_percentage_of_income"); 
chart3
    .width(300)
    .height(200)
    .dimension(housing_costs_as_a_percentage_of_income)
    .group(number_of_samples)
    .turnOnControls(true)
    .elasticX(true)
    .x(d3.scale.linear())
    .xAxisPadding(10)
    .xUnits(dc.units.fp.precision(bin_width_interactive_visualization_{{ project.id }}))
    .brushOn(true)
    .yAxisLabel("Number of households")
    .xAxisLabel("% of household income towards housing")




var residence_type = xfilter_interactive_visualization_{{ project.id }}.dimension(function(d) {return d.Residence_Type;}),
    number_of_samples = residence_type.group();

var chart2 = dc.rowChart("#residence_types");
chart2
    .width(300)
    .height(200)
    .x(d3.scale.ordinal())
    .elasticX(true)
    .dimension(residence_type)
    .group(number_of_samples)

chart3.render();
chart2.render();

// set up a data toggle using radio buttons

var dc_dimension = xfilter_interactive_visualization_{{ project.id }}.dimension(function(d) {return d[toggle_column];});
var handle_dc_switch_toggle = function(elem){
    var val = elem.value;
    dc_dimension.filterAll()
    dc_dimension.filter(function(d){return d == val;})
    dc.redrawAll();
}

var toggle_group = dc_dimension.group();
console.log(toggle_group)
console.log(toggle_group.all())
var keys = toggle_group.all().map(function(x) {return x.key;})
console.log("keys:", keys)
elem = document.getElementById("dc_switch")
for (var i = 0; i < keys.length; i++){
    var selected_str = ""
    if (i==0){
    selected_str = " checked='checked'"
    handle_dc_switch_toggle({"value":keys[i]})
    }
    elem.innerHTML += "<div class='radio-inline'><label><input type='radio' onclick='handle_dc_switch_toggle(this);' name='optradio' value='"+keys[i]+"'"+ selected_str +">"+keys[i]+"</label></div>"
}

// from the answer here: http://stackoverflow.com/questions/21114336/how-to-add-axis-labels-for-row-chart-using-dc-js-or-d3-js
// it's pretty weird (and terrible) that dc.js doesn't have this already...
function addXAxis(chartToUpdate, displayText)
{
    chartToUpdate.svg()
                .append("text")
                .attr("class", "x-axis-label")
                .attr("text-anchor", "middle")
                .attr("x", chartToUpdate.width()/2)
                .attr("y", chartToUpdate.height())
                .text(displayText);
}
{% if project.pie1_variable %}addXAxis(pie1_{{ project.id }}_chart.filterAll(), {{ project. }}){% endif %}
{% if project.pie1_variable %}pie1_{{ project.id }}_chart.filterAll(){% endif %}
addXAxis(chart2, "Number of Households");
chart3.filterAll()

// remove filters and redraw bar charts so they don't start out with a reset button 
// (due to what I assume is a dc.js bug)
{% if project.bar1_variable %}bar1_{{ project.id }}_chart.filterAll(){% endif %}
{% if project.bar2_variable %}bar2_{{ project.id }}_chart.filterAll(){% endif %}
dc.redrawAll()

</script>


{% endblock %}

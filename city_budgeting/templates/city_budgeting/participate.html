{% extends "core/base.html" %}
{% block content %}
{% load staticfiles %}


<h2>{{ project.name }}</h2>

<div id="top" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-12">
		    <h3 style="margin: 0px;">Budget Overview</h3>
		</div>
	    </div>

	    <p>
		This budget is for the fiscal period from {{ project.fiscal_period_start }} to {{ project.fiscal_period_end }}.
	    </p>
	    <p>
		To see the official budget document, go <a href="{{ project.budget_url }}">here</a>.
	    </p>

	    <ul>
		<li><a href="#" onclick="show_revenues()">Revenues</a></li>
		<li><a href="#" onclick="show_funds()">Funds</a></li>
		<li><a href="#" onclick="show_expenses()">Expenses</a></li>
	    </ul>

	</div>
    </div>
</div>

<div id="revenues" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Revenues Overview</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-6">
		    <div id="revenues_pie_div"></div>
		    <pre id="revenues_data" style="display: none;">id,name,amount
{% for rs in data.revenues %}{{ rs.id }},{{ rs.name }},{{ rs.amount }}
{% endfor %}</pre>
		</div>
		<div class="col-sm-6">
		    <ul>
			{% for rs in data.revenues %}
			<li><a href="#" onclick="show_detail('revenue', {{ rs.id }})">{{ rs.name }}</a></li>
			{% endfor %}	
		    </ul>
		</div>
	    </div>
	</div>
    </div>
</div>


{% for rs in data.revenues %}
<div id="revenue_source_div_{{ rs.id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Revenue Source: {{ rs.name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_revenues()">Back to Revenues</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <ul>
		<li><b>Amount:</b>{{ rs.amount }}</li>
		<li><b>Description:</b>{{ rs.description }}</li>
		{% if rs.reference %}<li><b>Reference:</b><a href="{{ rs.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}

{% for fund in data.funds %}
<div id="revenue_source_div_{{ fund.id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body">
	    <h3>City Fund: {{ fund.name }}</h3>
	    <ul>
		<li><b>Amount:</b>{{ fund.amount }}</li>
		<li><b>Description:</b>{{ fund.description }}</li>
		{% if fund.reference %}<li><b>Reference:</b><a href="{{ fund.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}

{% for expense in data.expenses %}
<div id="revenue_source_div_{{ expense.id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body">
	    <h3>Expense: {{ expense.name }}</h3>
	    <ul>
		<li><b>Amount:</b>{{ expense.amount }}</li>
		<li><b>Description:</b>{{ expense.description }}</li>
		{% if expense.reference %}<li><b>Reference:</b><a href="{{ expense.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}


<script>
 var show_revenues = function(){
     $(".vis-page").hide();
     $("#revenues").show();
     resize_charts();
 }
 
 var show_funds = function(){
     $(".vis-page").hide();
     $("#funds").show();
     resize_charts();
 }
 
 var show_expenses = function(){
     $(".vis-page").hide();
     $("#expenses").show();
     resize_charts();
 }
 
 var show_top = function(){
     $(".vis-page").hide();
     $("#top").show();
     resize_charts();
 }
 
 var show_detail = function(type, id){
     $(".vis-page").hide();
     var div_id = type+"_source_div_"+id;
     $("#"+div_id).show();
     resize_charts();
 }

var charts_info = [];

var create_pie = function(chart_div_id, data_pre_id, link_map){
     var parsed_data = d3.csv.parse(d3.select('pre#'+data_pre_id).text());
     var ndx = crossfilter(parsed_data);
     var name_dimension = ndx.dimension(function(d) { return d.name; });
     var sum_by_name = name_dimension.group( function(d){ return d;} ).reduceSum( function(d) { return +d.amount; })
     /* var top_amounts = sum_by_name.top(2); */

     var pie_chart = dc.pieChart("#"+chart_div_id);
     pie_chart.width(250)
	      .height(150)
	      .dimension(name_dimension)
	      .group(sum_by_name)
	      .legend(dc.legend())
	      .on("renderlet", (function(chart) {
		  pie_chart.selectAll('.pie-slice').on("click", function(d) {
		      var k = d.data.key;
		      if (k in link_map){
			  link_map[k](); // execute the function from link map
		      } else {
			  console.log("clicked, but key not in link map", k);
		      }
		  });
	      }));
     pie_chart.filter = function(){}; // turn off the filtering on click
     
     pie_chart.render()
     charts_info.push({"chart": pie_chart, "div_id": chart_div_id});
}


 var resize_charts = function(){
     for ( var i=0; i < charts_info.length; i++ ){
	 ci = charts_info[i];
	 // console.log("div id", ci.div_id);
	 var horizontal_space_available = document.getElementById(ci.div_id).parentNode.clientWidth - 20;
	 var width = d3.min([Math.floor(horizontal_space_available), 500]);
	 var height = d3.max([Math.floor(width * 1.0/2), 200])
	 ci.chart.width(width).height(height).redraw();
     }
 }

 $( window ).resize( function() {
     resize_charts();
 });


 $( document ).ready( function() {
     var revenues_link_map = {};
     {% for rs in data.revenues %}revenues_link_map["{{ rs.name }}"] = function(){show_detail('revenue', {{ rs.id }});};{% endfor %}

     create_pie("revenues_pie_div", "revenues_data", revenues_link_map);
     show_top();
 });



</script>


{% include "core/item_recommendations.html" %}
{% endblock %}

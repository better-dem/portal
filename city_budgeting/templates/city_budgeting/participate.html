{% extends "core/base.html" %}
{% block content %}
{% load staticfiles %}


<h2>{{ project.name }}</h2>

<div id="top" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-12">
		    <h3 style="margin: 0px;">Budget Overview</h3>
		</div>
	    </div>

	    <p>
		This budget is for the fiscal period from {{ project.fiscal_period_start }} to {{ project.fiscal_period_end }}.
	    </p>
	    <p>
		To see the official budget document, go <a href="{{ project.budget_url }}">here</a>.
	    </p>


	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-lg-6">

		    <ul>
			<li><a href="#" onclick="show_revenues()">Revenues</a></li>
			<li><a href="#" onclick="show_funds()">Funds</a></li>
			<li><a href="#" onclick="show_expenses()">Expenses</a></li>
		    </ul>

		</div>
		<div class="col-lg-6">

		    <ul>
			<li><b>Total Revenue: </b><span class="total_revenue"></span></li>
			<li><b>Total Expenses: </b><span class="total_expense"></span></li>
			<li><b>Result: </b><span class="total_result"></span></li>
		    </ul>


		</div>
	    </div>

	</div>
    </div>
</div>

<div id="revenues" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Revenues Overview</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-lg-6">
		    <div id="revenues_pie_div"></div>
		    <pre id="revenues_data" style="display: none;">id,name,category,amount
{% for rs in data.revenues.items %}{{ rs.id }},{{ rs.name }},{{ rs.category }},{{ rs.amount }}
{% endfor %}</pre>
		</div>
		<div class="col-lg-6">
		    <h4>Summary</h4>
		    <ul>
			<li><b>Total Revenue: </b><span class="total_revenue"></span></li>
		    </ul>
		</div>
	    </div>
	</div>
    </div>
</div>


<div id="expenses" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Expenses Overview</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-lg-6">
		    <div id="expenses_pie_div"></div>
		    <pre id="expenses_data" style="display: none;">id,name,category,amount
{% for exp in data.expenses.items %}{{ exp.id }},{{ exp.name }},{{ exp.category }},{{ exp.amount }}
{% endfor %}</pre>
		</div>
		<div class="col-lg-6">
		    <h4>Summary</h4>
		    <ul>
			<li><b>Total Expenses: </b><span class="total_expense"></span></li>
		    </ul>
		</div>
	    </div>
	</div>
    </div>
</div>



<div id="funds" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Funds Overview</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-lg-6">
		    <div id="funds_pie_div"></div>
		    <pre id="funds_data" style="display: none;">id,name,amount
{% for r in data.revenues.items %}{{ r.target_fund }},{% for k, v in fund_map.items %}{% if k == r.target_fund %}{{ v.name }}{% endif %}{% endfor %},{{ r.amount }}
{% endfor %}</pre>
		</div>
		<div class="col-lg-6">
		    <h4>Summary</h4>
		    <ul>
			<li>Number of Funds: {{ fund_map|length }}</li>
		    </ul>
		</div>
	    </div>
	</div>
    </div>
</div>


{% for c_id, c_name in revenue_categories.items %}
<div id="revenue_category_div_{{ c_id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Revenue Category: {{ c_name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_revenues()">Back to Revenues</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row">
		<div class="col-lg-6">
		  <div id="revenues_category_pie_div_{{ c_id }}"></div>
		    <pre id="revenues_data_cat_{{ c_id }}" style="display: none;">id,name,category,amount
{% for rs in data.revenues.items %}{% if rs.category == c_name %}{{ rs.id }},{{ rs.name }},{{ rs.category }},{{ rs.amount }}
{% endif %}{% endfor %}</pre>
		</div>
		<div class="col-lg-6">
		  Summary Forthcoming
		</div>
	    </div>
	</div>
    </div>
</div>
{% endfor %}



{% for c_id, c_name in expense_categories.items %}
<div id="expense_category_div_{{ c_id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Expense Category: {{ c_name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_expenses()">Back to Expenses</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <div class="row">
		<div class="col-lg-6">
		  <div id="expenses_category_pie_div_{{ c_id }}"></div>
		    <pre id="expenses_data_cat_{{ c_id }}" style="display: none;">id,name,category,amount
{% for exp in data.expenses.items %}{% if exp.category == c_name %}{{ exp.id }},{{ exp.name }},{{ exp.category }},{{ exp.amount }}
{% endif %}{% endfor %}</pre>
		</div>
		<div class="col-lg-6">
		  Summary Forthcoming
		</div>
	    </div>
	</div>
    </div>
</div>
{% endfor %}


{% for rs in data.revenues.items %}
<div id="revenue_div_{{ rs.id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Revenue Source: {{ rs.name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_revenues()">Back to Revenues</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <ul>
		<li><b>Amount: </b>${{ rs.amount }}</li>
		<li><b>Description: </b>{{ rs.description }}</li>
		{% if rs.reference %}<li><b>Reference: </b><a href="{{ rs.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}

{% for exp in data.expenses.items %}
<div id="expense_div_{{ exp.id }}" class="vis-page">
    <div class="panel panel-default">
	<div class="panel-body" style="min-height: 500px;">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">Expense: {{ exp.name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_expenses()">Back to Expenses</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>
	    <ul>
		<li><b>Amount: </b>${{ exp.amount }}</li>
		<li><b>Description: </b>{{ exp.description }}</li>
		{% if exp.reference %}<li><b>Reference: </b><a href="{{ exp.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}

{% for fund in data.funds.items %}
<div id="fund_div_{{ fund.id }}" class="vis-page">
    <div class="panel panel-default" style="min-height: 500px;">
	<div class="panel-body">
	    <div class="row" style="margin-top:10px; margin-bottom:10px;">
		<div class="col-sm-8">
		    <h3 style="margin: 0px;">City Fund: {{ fund.name }}</h3>
		</div>
		<div class="col-sm-4 text-right">
		    <a href="#" onclick="show_funds()">Back to Funds</a><br>
		    <a href="#" onclick="show_top()">Back to Top</a>
		</div>		
	    </div>

	    <ul>
		<li><b>Description: </b>{{ fund.description }}</li>
		{% if fund.reference %}<li><b>Reference:</b><a href="{{ fund.reference }}">Visit reference</a></li>{% endif %}
	    </ul>
	</div>
    </div>
</div>
{% endfor %}


<script>
 var show_revenues = function(){
     $(".vis-page").hide();
     $("#revenues").show();
     resize_charts();
 }
 
 var show_funds = function(){
     $(".vis-page").hide();
     $("#funds").show();
     resize_charts();
 }
 
 var show_expenses = function(){
     $(".vis-page").hide();
     $("#expenses").show();
     resize_charts();
 }
 
 var show_top = function(){
     $(".vis-page").hide();
     $("#top").show();
     resize_charts();
 }
 
 var show_detail = function(type, id){
     $(".vis-page").hide();
     var div_id = type+"_div_"+id;
     $("#"+div_id).show();
     resize_charts();
 }

var charts_info = [];

var create_pie = function(dimension_var, chart_div_id, data_pre_id, link_map){
     var parsed_data = d3.csv.parse(d3.select('pre#'+data_pre_id).text());
     var ndx = crossfilter(parsed_data);
     var name_dimension = ndx.dimension(function(d) { return d[dimension_var]; });
     var sum_by_name = name_dimension.group( function(d){ return d;} ).reduceSum( function(d) { return +d.amount; });

     var pie_chart = dc.pieChart("#"+chart_div_id);
     pie_chart.width(250)
	      .height(150)
	      .dimension(name_dimension)
	      .group(sum_by_name)
	      .legend(dc.legend())
	      .on("renderlet", (function(chart) {
		  pie_chart.selectAll('.pie-slice').on("click", function(d) {
		      var k = d.data.key;
		      if (k in link_map){
			  link_map[k](); // execute the function from link map
		      } else {
			  console.log("clicked, but key not in link map", k);
		      }
		  });
	      }));
     pie_chart.filter = function(){}; // turn off the filtering on click
     
     pie_chart.render()
     charts_info.push({"chart": pie_chart, "div_id": chart_div_id});
}


 var resize_charts = function(){
     for ( var i=0; i < charts_info.length; i++ ){
	 ci = charts_info[i];
	 // console.log("div id", ci.div_id);
	 var horizontal_space_available = document.getElementById(ci.div_id).parentNode.clientWidth - 20;
	 if (horizontal_space_available > 0){
	     var width = d3.min([Math.floor(horizontal_space_available), 500]);
	     var height = width;
	     ci.chart.radius(3*height/8).width(width).height(height).redraw();
	 }
     }
 }

 $( window ).resize( function() {
     resize_charts();
 });


 $( document ).ready( function() {
     //// create charts
     // create linked pie chart for revenue summary pane
     var revenues_link_map = {};
     {% for i, rc in revenue_categories.items %}revenues_link_map["{{ rc|escapejs }}"] = function(){show_detail('revenue_category', {{ i }});};{% endfor %}
     create_pie("category", "revenues_pie_div", "revenues_data", revenues_link_map);
     
     // create linked pie chart for expense summary pane
     var expenses_link_map = {};
     {% for i, ec in expense_categories.items %}expenses_link_map["{{ ec|escapejs }}"] = function(){show_detail('expense_category', {{ i }});};{% endfor %}
     create_pie("category", "expenses_pie_div", "expenses_data", expenses_link_map);
     
     // create linked pie chart for funds summary pane
     var funds_link_map = {};
     {% for f in data.funds.items %}funds_link_map["{{ f.name|escapejs }}"] = function(){show_detail('fund', {{ f.id }});};{% endfor %}
     create_pie("category", "funds_pie_div", "funds_data", funds_link_map);


     // create pies for revenue categories
     {% for i, rc in revenue_categories.items %}
     var revenues_link_map_{{ i }} = {};
     {% for r in data.revenues.items %}{% if r.category == rc %}revenues_link_map_{{ i }}["{{ r.name|escapejs }}"] = function(){show_detail('revenue', {{ r.id }});};{% endif %}{% endfor %}
     create_pie("name", "revenues_category_pie_div_{{ i }}", "revenues_data_cat_{{ i}}", revenues_link_map_{{ i }});
     {% endfor %}

     // create pies for expense categories
     {% for i, ex in expense_categories.items %}
     var expenses_link_map_{{ i }} = {};
     {% for exp in data.expenses.items %}{% if exp.category == ex %}expenses_link_map_{{ i }}["{{ exp.name|escapejs }}"] = function(){show_detail('expense', {{ exp.id }});};{% endif %}{% endfor %}
     create_pie("name", "expenses_category_pie_div_{{ i }}", "expenses_data_cat_{{ i}}", expenses_link_map_{{ i }});
     {% endfor %}

     //// calculate totals and insert them into document
     var total_revenue = 0;
     {% for rs in data.revenues.items %}
     total_revenue += {{ rs.amount }};
     {% endfor %}     
     $(".total_revenue").text("$"+total_revenue);

     var total_expense = 0;
     {% for exp in data.expenses.items %}
     total_expense += {{ exp.amount }};
     {% endfor %}     
     $(".total_expense").text("$"+total_expense);

     var total_result = total_revenue - total_expense;
     if (total_result < 0){
	 $(".total_result").text("Deficit of $" + -1*total_result);
     } else {
	 $(".total_result").text("Surplus of $" + total_result);
     }
     show_top();
 });


</script>


{% include "core/item_recommendations.html" %}
{% endblock %}
